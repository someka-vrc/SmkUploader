<Window x:Class="SmkUploaderSetting.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SmkUploaderSetting"
        xmlns:vm="clr-namespace:SmkUploaderSetting.ViewModels"
        xmlns:conv="clr-namespace:SmkUploaderSetting.Converters"
        mc:Ignorable="d"
        Title="SmkUploader 設定" Height="700" Width="500"
        WindowStartupLocation="CenterScreen"
        MinWidth="520">

    <Window.InputBindings>
        <KeyBinding Key="S" Modifiers="Control" Command="{Binding SaveCommand}" />
    </Window.InputBindings>

    <Window.DataContext>
        <vm:SettingViewModel />
    </Window.DataContext>

    <Window.Resources>
        <!-- トグルスイッチ風CheckBox用Style -->
        <Style x:Key="ToggleSwitchStyle" TargetType="CheckBox">
            <Setter Property="Focusable" Value="False" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="CheckBox">
                        <Grid Width="44" Height="24">
                            <Border x:Name="SwitchBorder" CornerRadius="12" Background="#DDD" BorderBrush="#CCC" BorderThickness="1" />
                            <Ellipse x:Name="SwitchKnob" Width="20" Height="20" Fill="White" Stroke="#CCC" StrokeThickness="1" Margin="2,2,0,2" HorizontalAlignment="Left" />
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="SwitchBorder" Property="Background" Value="{DynamicResource AccentBrush}" />
                                <Setter TargetName="SwitchBorder" Property="BorderBrush" Value="{DynamicResource AccentBrush}" />
                                <Setter TargetName="SwitchKnob" Property="Margin" Value="22,2,0,2" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="SwitchBorder" Property="Background" Value="#EEE" />
                                <Setter TargetName="SwitchKnob" Property="Fill" Value="#CCC" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <conv:StringToComboBoxItemConverter x:Key="StringToComboBoxItemConverter" />
        <conv:SafeBooleanConverter x:Key="SafeBooleanConverter" />
        <conv:SafeStringConverter x:Key="SafeStringConverter" />
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <conv:StringNullOrEmptyToVisibilityConverter x:Key="StringNullOrEmptyToVisibilityConverter" />
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" /> <!-- ボタンエリア -->
            <RowDefinition Height="*" />    <!-- 設定項目エリア -->
            <RowDefinition Height="Auto" /> <!-- ステータスバー -->
        </Grid.RowDefinitions>

        <!-- ボタンエリア（上部・右寄せ） -->
        <Border Grid.Row="0" Padding="20,10,20,10">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top" >
                <!-- ステータスメッセージ -->
                <TextBlock Text="{Binding StatusMessage}" 
                          FontWeight="Bold" Foreground="Green" 
                          Margin="0,0,10,0"
                          VerticalAlignment="Center"
                          Visibility="{Binding ShowStatus, Converter={StaticResource BooleanToVisibilityConverter}}" />
                <!-- ボタン -->
                <Button Content="保存" Command="{Binding SaveCommand}" 
                       IsEnabled="{Binding CanSave}"
                       Width="80" Height="30" Margin="0,0,10,0"
                       Background="{DynamicResource AccentBrush}"
                       BorderBrush="{DynamicResource AccentBrush}"
                       Foreground="White" />
                <Button Content="リセット" Command="{Binding ResetCommand}" 
                       Width="80" Height="30" />
            </StackPanel>
        </Border>

        <!-- 設定項目エリア -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="30,0,30,0">
            <StackPanel>
                <ItemsControl ItemsSource="{Binding Items}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="0,20,0,0" Padding="0,0,0,10" >
                                <StackPanel>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="4*" />
                                            <ColumnDefinition Width="20" /> <!-- スペース用カラムを追加 -->
                                            <ColumnDefinition Width="2*" />
                                        </Grid.ColumnDefinitions>
                                        <!-- 左側：ラベル・説明 -->
                                        <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding DisplayLabel}" FontWeight="Bold" Margin="0,0,0,2" />
                                            <TextBlock Text="{Binding Description}"
                                                       Margin="0,0,0,5" FontSize="12"
                                                       TextWrapping="Wrap"
                                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                            <!-- サービス利用規約リンク表示（SMKU_SERVICEのときのみ） -->
                                            <TextBlock Margin="0,0,0,5" FontSize="12">
                                                <TextBlock.Style>
                                                    <Style TargetType="TextBlock">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Key}" Value="SMKU_SERVICE">
                                                                <Setter Property="Visibility" Value="{Binding DataContext.SelectedServiceTermsUrl, RelativeSource={RelativeSource AncestorType=Window}, Converter={StaticResource StringNullOrEmptyToVisibilityConverter}}" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBlock.Style>
                                                <Hyperlink NavigateUri="{Binding DataContext.SelectedServiceTermsUrl, RelativeSource={RelativeSource AncestorType=Window}}"
                                                           RequestNavigate="Hyperlink_RequestNavigate">
                                                    サービスの利用規約
                                                </Hyperlink>
                                            </TextBlock>
                                        </StackPanel>
                                        <!--スペーサー -->
                                        <StackPanel Grid.Column="1"></StackPanel>
                                        <!-- 右側：入力欄 -->
                                        <StackPanel Grid.Column="2" HorizontalAlignment="Right">
                                            <!-- 入力欄（Bool型の場合） -->
                                            <CheckBox IsChecked="{Binding Value, Converter={StaticResource SafeBooleanConverter}}" 
                                                     Visibility="{Binding IsBoolType, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                     Margin="0,0,0,5"
                                                     Style="{StaticResource ToggleSwitchStyle}" />

                                            <!-- 入力欄（ログレベル選択の場合） -->
                                            <ComboBox SelectedValue="{Binding ValueAsString, UpdateSourceTrigger=PropertyChanged}"
                                                     SelectedValuePath="Content"
                                                     Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                     Margin="0,0,0,5">
                                                <ComboBox.ItemContainerStyle>
                                                    <Style TargetType="ComboBoxItem">
                                                        <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                                                    </Style>
                                                </ComboBox.ItemContainerStyle>
                                                <ComboBox.Style>
                                                    <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Key}" Value="SMKU_LOG_LEVEL">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ComboBox.Style>
                                                <ComboBoxItem Content="Verbose" />
                                                <ComboBoxItem Content="Information" />
                                                <ComboBoxItem Content="Warning" />
                                                <ComboBoxItem Content="Error" />
                                            </ComboBox>

                                            <!-- 入力欄（サービス選択の場合） -->
                                            <ComboBox SelectedValue="{Binding ValueAsString, UpdateSourceTrigger=PropertyChanged}"
                                                     SelectedValuePath="Tag"
                                                     Foreground="{DynamicResource TextFillColorPrimaryBrush}"
                                                     Margin="0,0,0,5">
                                                <ComboBox.ItemContainerStyle>
                                                    <Style TargetType="ComboBoxItem">
                                                        <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                                                    </Style>
                                                </ComboBox.ItemContainerStyle>
                                                <ComboBox.Style>
                                                    <Style TargetType="ComboBox" BasedOn="{StaticResource {x:Type ComboBox}}">
                                                        <Setter Property="Visibility" Value="Collapsed" />
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding Key}" Value="SMKU_SERVICE">
                                                                <Setter Property="Visibility" Value="Visible" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ComboBox.Style>
                                                <ComboBoxItem Content="Gyazo" Tag="GYAZO" />
                                                <ComboBoxItem Content="imgBB" Tag="IMGBB" />
                                                <ComboBoxItem Content="Freeimage.host" Tag="FREEIMAGEHOST" />
                                            </ComboBox>

                                            <!-- 入力欄（その他のText型の場合） -->
                                            <TextBox Text="{Binding Value, Converter={StaticResource SafeStringConverter}, UpdateSourceTrigger=PropertyChanged}" MinWidth="120">
                                                <TextBox.Style>
                                                    <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                                                        <Setter Property="Visibility" Value="Visible" />

                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsBoolType}" Value="True">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Key}" Value="SMKU_LOG_LEVEL">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding Key}" Value="SMKU_SERVICE">
                                                                <Setter Property="Visibility" Value="Collapsed" />
                                                            </DataTrigger>
                                                            <!-- エラー時の装飾 -->
                                                            <DataTrigger Binding="{Binding HasError}" Value="True">
                                                                <Setter Property="BorderBrush" Value="#FF4B4B" />
                                                                <Setter Property="Background" Value="#FFF6F6" />
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </TextBox.Style>
                                            </TextBox>
                                        </StackPanel>
                                    </Grid>
                                    <!-- エラーメッセージをGridの下、StackPanel内に配置 -->
                                    <Border Background="#FFF6F6" CornerRadius="6" Padding="6,2" Margin="0,4,0,0"
                                            Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}"
                                            BorderBrush="Red" BorderThickness="1">
                                        <TextBlock Text="{Binding Error}" 
                                                   FontSize="11" Foreground="Black" 
                                                   VerticalAlignment="Center" />
                                    </Border>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </ScrollViewer>

        <!-- ステータスバー（下部固定・右寄せ） -->
        <Border Grid.Row="2" Padding="8" BorderThickness="0" BorderBrush="#DDD">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                <TextBlock VerticalAlignment="Center" Margin="0,0,16,0">
                    <Run Text="Ver."/>
                    <Run Text="{Binding Version, Mode=OneWay}"/>
                </TextBlock>
                <TextBlock VerticalAlignment="Center">
                    <Hyperlink NavigateUri="https://docs.google.com/document/d/1Lng8lue28fDLf1T5D6NUervUHl-wxoci__3t3xWaQc4" RequestNavigate="Hyperlink_RequestNavigate">ヘルプページ</Hyperlink>
                </TextBlock>
            </StackPanel>
        </Border>
    </Grid>
</Window>
